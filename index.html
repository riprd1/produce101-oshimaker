<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ—¥ãƒ—æ–°ä¸–ç•Œ æ¨ã—ãƒ¡ãƒ¼ã‚«ãƒ¼</title>

<style>
  :root{
    --bg:#f3f4f6;
    --card:#ffffff;
    --line:#e6e6e6;
    --text:#111;
    --muted:#666;
    --shadow: 0 8px 24px rgba(0,0,0,.08);
    --radius:16px;
    --blue:#1a73e8;

    /* JSã§è¨ˆç®—ã—ã¦å…¥ã‚Œã‚‹ï¼ˆãƒ”ãƒ©ãƒŸãƒƒãƒ‰ãŒå¿…ãšåã¾ã‚‹ï¼‰ */
    --slot: 92px;     /* ä¸¸ã®å¤–æ ã‚µã‚¤ã‚º */
    --ring: 6px;      /* å¤–æ ã®å¤ªã• */
    --gap: 16px;      /* æ¨ªã®é–“éš” */
    --rowgap: 18px;   /* ç¸¦ã®é–“éš” */
    --badge: 30px;    /* é †ä½ãƒãƒƒã‚¸ç›´å¾„ */
    --badgeFont: 13px;

    --headerH: 100px; /* ç”»é¢ä¸Šãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒã®é«˜ã• */
  }

  body{
    margin:0;
    font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:var(--bg);
    color:var(--text);
    -webkit-text-size-adjust: 100%;
  }

  header{
    position: sticky;
    top: 0;
    z-index: 20;
    background: rgba(255,255,255,.92);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--line);
  }
  .topbar{
    padding: 12px 12px 10px;
    max-width: 980px;
    margin: 0 auto;
  }
  h1{margin:0;font-size:20px;line-height:1.2}
  .by{margin:6px 0 0;font-size:13px;color:var(--muted)}

  main{max-width:980px;margin:0 auto;padding:12px;}

  .card{
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  /* ä¸Šéƒ¨ãƒãƒŠãƒ¼ */
  .banner{
    height: var(--headerH);
    position: relative;
    display:flex;
    align-items:center;
    justify-content:center;
    background:
      radial-gradient(circle at 20% 30%, rgba(255,120,200,.30), transparent 40%),
      radial-gradient(circle at 80% 40%, rgba(120,160,255,.28), transparent 45%),
      linear-gradient(135deg, #ffe7f4, #eef3ff);
  }
  .banner.hasImage{
    background-size: cover;
    background-position: center;
  }
  .banner::after{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(to bottom, rgba(255,255,255,.0), rgba(255,255,255,.35));
    pointer-events:none;
  }
  .bannerTitle{
    position:absolute;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    font-weight: 900;
    letter-spacing: .06em;
    padding: 9px 14px;
    border-radius: 999px;
    background: rgba(255,255,255,.80);
    border: 1px solid rgba(255,255,255,.90);
    font-size: 14px;
    white-space: nowrap;
  }

  /* ãƒ”ãƒ©ãƒŸãƒƒãƒ‰ï¼ˆ11æ ï¼š1/2/3/5ï¼‰ */
  .pyramidWrap{
    padding: 12px 12px 10px;
    background: #fff;
  }
  .pyramid{
    width: 100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap: var(--rowgap);
    padding: 12px 0 6px;
    box-sizing: border-box;
  }
  .row{
    display:flex;
    justify-content:center;
    gap: var(--gap);
    width: 100%;
  }

  .slot{
    width: var(--slot);
    text-align:center;
    position:relative;
    flex: 0 0 var(--slot);
  }

  /* ä¸¸ï¼ˆç”»åƒã¯ background-image ã§è¡¨ç¤ºï¼šé•·æŠ¼ã—ä¿å­˜ã•ã‚Œã«ãã„ï¼‰ */
  .avatar{
    width: var(--slot);
    height: var(--slot);
    border-radius: 999px;
    border: var(--ring) solid #d9d9d9;
    background: #f6f6f6;
    box-shadow: 0 10px 22px rgba(0,0,0,.10);
    position: relative;
    overflow: visible; /* ãƒãƒƒã‚¸ã‚’çµ¶å¯¾ã«éš ã•ãªã„ */
    margin: 0 auto;
    box-sizing: border-box;
  }
  .avatarImg{
    position:absolute;
    left:0; top:0; right:0; bottom:0;
    border-radius: 999px;
    background-size: cover;
    background-position: center;
    background-repeat:no-repeat;
  }

  /* æœªé¸æŠã®ï¼‹ */
  .empty .avatar{
    background: #e9e9e9;
    border-color:#dcdcdc;
    box-shadow:none;
  }
  .empty .avatarImg{display:none;}
  .plus{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight: 900;
    font-size: calc(var(--slot) * 0.34);
    color:#888;
    user-select:none;
  }

  /* é †ä½ãƒãƒƒã‚¸ï¼šä¸¸ã®ã€ŒçœŸã‚“ä¸­ä¸‹ã€ã©çœŸã‚“ä¸­å›ºå®š */
  .rank{
    position:absolute;
    left:50%;
    bottom: calc(-1 * (var(--badge) * 0.46));
    transform: translateX(-50%);
    width: var(--badge);
    height: var(--badge);
    border-radius: 999px;
    background: var(--blue);
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight: 900;
    font-size: var(--badgeFont);
    border: 3px solid #fff;
    box-shadow: 0 6px 14px rgba(0,0,0,.16);
    z-index: 5;
    line-height: 1;
    pointer-events:none;
  }

  /* åå‰ï¼šãƒãƒƒã‚¸ã®ä¸‹ */
  .name{
    margin-top: calc(var(--badge) * 0.70);
    font-size: 13px;
    font-weight: 800;
    line-height: 1.2;
    letter-spacing: .01em;
    color:#111;
    word-break: keep-all;
    white-space: normal;
  }

  /* ä¸¦ã³æ›¿ãˆï¼šçŸ¢å°ã§ç¢ºå®Ÿã«å…¥ã‚Œæ›¿ãˆ */
  .reorder{
    margin-top: 8px;
    display:flex;
    justify-content:center;
    gap: 10px;
  }
  .reorder button{
    width: 44px;
    height: 32px;
    border-radius: 999px;
    border: 1px solid #dadada;
    background: #fff;
    font-size: 18px;
    line-height: 1;
    color: var(--blue);
  }
  .reorder button:active{transform:scale(.98)}

  /* æ“ä½œãƒœã‚¿ãƒ³ */
  .actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
    padding: 12px 10px 14px;
  }
  button{
    padding: 11px 14px;
    border-radius: 12px;
    border: 1px solid #ddd;
    background: #fff;
    font-size: 14px;
  }
  button:active{transform:scale(.98)}
  .primary{border-color:#cfe2ff;}
  .danger{border-color:#ffd6d6;}

  /* ä¸‹ï¼šæ¤œç´¢ + è¡¨ç¤ºåˆ‡æ›¿ + ä¸€è¦§ */
  .listCard{
    margin-top: 12px;
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .listHead{
    display:flex;
    align-items:center;
    gap: 10px;
    padding: 10px;
    border-bottom: 1px solid var(--line);
  }

  /* æ¤œç´¢ãƒãƒ¼ï¼ˆå‚è€ƒç”»åƒé¢¨ï¼‰ */
  .searchWrap{
    flex: 1;
    display:flex;
    align-items:center;
    gap: 8px;
    background: #efeff0;
    border: 1px solid #e3e3e3;
    border-radius: 12px;
    padding: 10px 10px;
    box-sizing:border-box;
  }
  .searchIcon{
    width:18px;height:18px;
    display:flex;align-items:center;justify-content:center;
    color:#888;
    user-select:none;
  }
  .searchInput{
    flex:1;
    border:none;
    outline:none;
    background: transparent;
    font-size: 16px;
  }
  .clearBtn{
    border:none;
    background: transparent;
    font-size: 18px;
    color:#888;
    padding: 4px 6px;
    border-radius: 10px;
  }
  .clearBtn:active{transform:scale(.98)}

  /* è¡¨ç¤ºåˆ‡æ›¿ãƒœã‚¿ãƒ³ï¼ˆå³å´ï¼‰ */
  .viewToggles{
    display:flex;
    gap: 8px;
  }
  .toggle{
    border: 1px solid #dcdcdc;
    background:#fff;
    border-radius: 10px;
    padding: 9px 10px;
    font-size: 13px;
    white-space: nowrap;
  }
  .toggle.active{
    border-color:#cfe2ff;
    color: var(--blue);
    font-weight: 800;
  }

  /* ä¸€è¦§æ ï¼šä¸­ã ã‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
  #membersWrap{
    max-height: 44vh;
    overflow:auto;
    -webkit-overflow-scrolling: touch;
    padding: 10px;
    background:#fff;
  }

  /* ä¸€è¦§ï¼šã‚°ãƒªãƒƒãƒ‰/ãƒªã‚¹ãƒˆåˆ‡æ›¿ */
  #members.grid{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 10px;
  }
  #members.list{
    display:flex;
    flex-direction:column;
    gap: 10px;
  }

  .member{
    border: 1px solid #efefef;
    border-radius: 14px;
    background:#fff;
    cursor:pointer;
    user-select:none;
  }
  .member:active{transform:scale(.99)}

  /* ã‚°ãƒªãƒƒãƒ‰ã‚«ãƒ¼ãƒ‰ */
  .member.gridCard{
    padding: 10px 8px;
    text-align:center;
  }
  .thumb{
    width:72px;height:72px;
    border-radius:999px;
    border: 3px solid #f1f1f1;
    margin: 0 auto 8px;
    background:#f6f6f6;
    background-size: cover;
    background-position:center;
    background-repeat:no-repeat;
  }
  .memberName{
    font-size:12px;
    font-weight: 800;
    line-height: 1.2;
  }

  /* ãƒªã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ */
  .member.listRow{
    display:flex;
    align-items:center;
    gap: 10px;
    padding: 10px;
  }
  .thumbSmall{
    width:52px;height:52px;
    border-radius:999px;
    border: 3px solid #f1f1f1;
    background:#f6f6f6;
    background-size: cover;
    background-position:center;
    background-repeat:no-repeat;
    flex: 0 0 52px;
  }
  .memberNameRow{
    font-size:14px;
    font-weight: 900;
    line-height: 1.2;
  }
  .memberSub{
    margin-top: 4px;
    font-size: 12px;
    color: var(--muted);
    font-weight: 700;
  }

  .member.selected{
    opacity:.35;
    filter: grayscale(1);
    pointer-events:none;
  }

  .noResult{
    padding: 16px;
    text-align:center;
    color: var(--muted);
    font-weight: 800;
  }

  .toast{
    position: fixed;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    background: rgba(0,0,0,.78);
    color:#fff;
    padding: 10px 12px;
    border-radius: 999px;
    font-size: 13px;
    display:none;
    z-index:999;
  }

  /* ä¿å­˜å°‚ç”¨ï¼ˆç”»é¢å¤–ï¼‰â€” 1004Ã—924 å›ºå®š */
  #exportArea{
    position: fixed;
    left: -20000px;
    top: 0;
    width: 1004px;
    height: 924px;
    background:#fff;
    overflow:hidden;
  }
  #exportInner{
    width: 1004px;
    height: 924px;
    position:relative;
    background:#fff;
  }
  .exportBanner{
    height: 150px;
    background-size: cover;
    background-position: center;
    position:relative;
  }
  .exportBanner::after{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(to bottom, rgba(255,255,255,.0), rgba(255,255,255,.30));
    pointer-events:none;
  }
  .exportPill{
    position:absolute;
    left:50%;
    top:50%;
    transform: translate(-50%,-50%);
    font-weight: 900;
    letter-spacing:.06em;
    padding: 14px 22px;
    border-radius: 999px;
    background: rgba(255,255,255,.80);
    border: 1px solid rgba(255,255,255,.92);
    font-size: 22px;
    color:#111;
    white-space: nowrap;
  }
  .exportBody{
    padding: 28px 72px 0;
    box-sizing:border-box;
  }
  .exportPyramid{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap: 34px;
    padding-top: 10px;
  }
  .exportRow{
    display:flex;
    justify-content:center;
    gap: 40px; /* ç«¯åˆ‡ã‚Œã—ãªã„ã‚ˆã†ã«å›ºå®š */
    width:100%;
  }
  .exportSlot{
    width: 140px;
    text-align:center;
    position:relative;
    flex: 0 0 140px;
  }
  .exportAvatar{
    width:140px;height:140px;
    border-radius:999px;
    border: 10px solid #d9d9d9;
    background:#f6f6f6;
    position:relative;
    margin: 0 auto;
    box-shadow: 0 10px 24px rgba(0,0,0,.12);
    overflow: visible;
    box-sizing:border-box;
  }
  .exportAvatarImg{
    position:absolute; inset:0;
    border-radius:999px;
    background-size: cover;           /* é¡”ã¤ã¶ã‚Œã‚¼ãƒ­ */
    background-position:center;
    background-repeat:no-repeat;
  }
  .exportPlus{
    position:absolute; inset:0;
    display:flex;align-items:center;justify-content:center;
    font-size: 54px;
    font-weight: 900;
    color:#888;
    user-select:none;
  }
  .exportRank{
    position:absolute;
    left:50%;
    bottom: -22px;
    transform: translateX(-50%);
    width: 44px;
    height: 44px;
    border-radius:999px;
    background: var(--blue);
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight: 900;
    font-size: 18px;
    border: 4px solid #fff;
    box-shadow: 0 6px 14px rgba(0,0,0,.14);
    z-index:5;
    line-height:1;
  }
  .exportName{
    margin-top: 28px; /* ãƒãƒƒã‚¸åˆ†ã®ä½™ç™½ã‚’ç¢ºä¿ï¼ˆè¢«ã‚Šé˜²æ­¢ï¼‰ */
    font-size: 16px;
    font-weight: 900;
    line-height: 1.2;
    color:#111;
    white-space: normal;
    word-break: keep-all;
  }
  .exportEmpty{
    opacity:.14;
    filter: grayscale(1);
  }
  .exportFooter{
    position:absolute;
    left:0; right:0;
    bottom: 18px;
    text-align:center;
    font-size: 16px;
    color:#666;
    font-weight: 800;
  }

  /* ã§ãã‚‹ã ã‘é•·æŠ¼ã—ä¿å­˜ã—ã«ããã™ã‚‹ï¼ˆå®Œå…¨é˜²æ­¢ã¯ä¸å¯ï¼‰ */
  *{-webkit-touch-callout: none;}
</style>
</head>

<body>
<header>
  <div class="topbar">
    <h1>æ—¥ãƒ—æ–°ä¸–ç•Œ æ¨ã—ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>
    <p class="by">created by @12agassi</p>
  </div>
</header>

<main>

  <!-- ä¸Šï¼šãƒ”ãƒ©ãƒŸãƒƒãƒ‰ -->
  <div class="card">
    <div id="banner" class="banner">
      <div class="bannerTitle">AUDITION PICK â€¢ YOUR TOP 11</div>
    </div>

    <div class="pyramidWrap">
      <div class="pyramid" id="pyramid"></div>
    </div>

    <div class="actions">
      <button class="primary" onclick="saveImage()">ç”»åƒã¨ã—ã¦ä¿å­˜</button>
      <button onclick="undo()">1äººæˆ»ã™</button>
      <button class="danger" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

  <!-- ä¸‹ï¼šæ¤œç´¢ï¼‹è¡¨ç¤ºåˆ‡æ›¿ï¼‹ä¸€è¦§ -->
  <div class="listCard">
    <div class="listHead">
      <div class="searchWrap">
        <div class="searchIcon">ğŸ”</div>
        <input id="search" class="searchInput" type="text" placeholder="Search" autocomplete="off" />
        <button id="clear" class="clearBtn" aria-label="clear" title="clear">Ã—</button>
      </div>

      <div class="viewToggles">
        <button id="btnList" class="toggle" onclick="setView('list')">1åˆ—</button>
        <button id="btnGrid" class="toggle active" onclick="setView('grid')">3åˆ—</button>
      </div>
    </div>

    <div id="membersWrap">
      <div id="members" class="grid"></div>
      <div id="noResult" class="noResult" style="display:none;">è©²å½“ãªã—</div>
    </div>
  </div>

</main>

<div class="toast" id="toast">ç”»åƒã‚’ç”Ÿæˆä¸­â€¦</div>

<!-- ä¿å­˜å°‚ç”¨ï¼ˆç”»é¢å¤–ï¼‰ -->
<div id="exportArea" aria-hidden="true">
  <div id="exportInner">
    <div id="exportBanner" class="exportBanner">
      <div class="exportPill">AUDITION PICK â€¢ YOUR TOP 11</div>
    </div>
    <div class="exportBody">
      <div class="exportPyramid" id="exportPyramid"></div>
    </div>
    <div class="exportFooter">created by @12agassi</div>
  </div>
</div>

<!-- html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* =========================
   è¨­å®š
========================= */

/* ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒï¼ˆã‚ãªãŸã®ç”»åƒï¼‰ */
const HEADER_IMAGE_URL = "https://i.imgur.com/nYBRUdd.png";

/* ãƒ”ãƒ©ãƒŸãƒƒãƒ‰ã®å½¢ï¼ˆ11æ ï¼‰ */
const rowSizes = [1,2,3,5];
const MAX = 11;

/* ä¿å­˜ã‚­ãƒ¼ */
const STORAGE_KEY = "oshimaker_final_v1";

/* ç·´ç¿’ç”Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆè¿½åŠ æ¸ˆã¿ï¼šã‚ãªãŸãŒé€ã£ã¦ãã‚ŒãŸåˆ†ï¼‰ */
const trainees = [
  {name:"ã‚¢ãƒ€ãƒ ãƒ»ãƒŠã‚¬ã‚¤(ADAM)", img:"https://i.imgur.com/6QGzvRx.png"},
  {name:"ä¸­ä¸¸ æ™å¯¿(AJU)", img:"https://i.imgur.com/KiZCKos.png"},
  {name:"ã‚ªãƒ ãƒ»ã‚¹ã‚¢ãƒ³ã‚«ãƒ¯ãƒ¼ãƒ†ãƒ³(AOM)", img:"https://i.imgur.com/dDIFJSc.png"},
  {name:"ã‚¢ãƒ¼ãƒãƒ£ãƒ¼ãƒ»ã‚¦ã‚¤(ARCHER)", img:"https://i.imgur.com/5iIerqN.png"},
  {name:"ç¯ ãƒ¶è°· æ­©å¤¢(S.AYUMU)", img:"https://i.imgur.com/YJAdh8q.png"},

  {name:"å°æ— åƒæ‚Ÿ(CHISATO)", img:"https://i.imgur.com/Iu0hNBO.png"},
  {name:"åŠ è—¤ å¤§æ¨¹(K.DAIKI)", img:"https://i.imgur.com/4fRk2EB.png"},
  {name:"ã‚«ã‚¯ãƒ»ãƒ‰ãƒ³ãƒŸãƒ³(DONGMIN)", img:"https://i.imgur.com/xZSQqMh.png"},
  {name:"æœ«å· ç‘›å¤ª(EITA)", img:"https://i.imgur.com/alEjKCP.png"},
  {name:"ä¿é‡Œ ç‘›éƒ½(H.EITO)", img:"https://i.imgur.com/IAhs4ZA.png"},
  {name:"é‡‘ç”° æ „éƒ½(K.EITO)", img:"https://i.imgur.com/tF7i1du.png"},
  {name:"æ«»äº• æ¥“çœŸ(FUMA)", img:"https://i.imgur.com/WIWI8Sx.png"}
];

/* =========================
   ä¾¿åˆ©é–¢æ•°ï¼ˆåå‰è¡¨ç¤º/æ¤œç´¢ï¼‰
========================= */
function displayJPName(full){
  // ()ã®å‰ã ã‘è¡¨ç¤ºï¼ˆæ—¥æœ¬èªã ã‘ï¼‰
  const idx = full.indexOf("(");
  return (idx >= 0 ? full.slice(0, idx) : full).trim();
}
function codeInParen(full){
  // ()å†…ã ã‘ï¼ˆè‹±å­—ãªã©ï¼‰
  const m = full.match(/\(([^)]+)\)/);
  return m ? m[1].trim() : "";
}
function normalize(s){
  return (s || "")
    .toLowerCase()
    .replace(/\s+/g,"")
    .replace(/[().ãƒ»\-ï¼¿_]/g,"");
}

/* =========================
   çŠ¶æ…‹
========================= */
let selected = loadSelected();     // traineesã®indexé…åˆ—ï¼ˆæœ€å¤§11ï¼‰
let viewMode = loadViewMode();     // 'grid' or 'list'
let query = "";

/* =========================
   åˆæœŸï¼šãƒ˜ãƒƒãƒ€ãƒ¼èƒŒæ™¯
========================= */
(function setupBanners(){
  const banner = document.getElementById("banner");
  const exportBanner = document.getElementById("exportBanner");
  if(HEADER_IMAGE_URL){
    banner.classList.add("hasImage");
    banner.style.backgroundImage = `url('${HEADER_IMAGE_URL}')`;
    exportBanner.style.backgroundImage = `url('${HEADER_IMAGE_URL}')`;
  }
})();

/* =========================
   ãƒ”ãƒ©ãƒŸãƒƒãƒ‰ãŒå¿…ãšç”»é¢å†…ã«åã¾ã‚‹ã‚µã‚¤ã‚ºè¨ˆç®—
========================= */
function updatePyramidSizes(){
  const card = document.querySelector(".card");
  if(!card) return;

  // ãƒ”ãƒ©ãƒŸãƒƒãƒ‰ã‚¨ãƒªã‚¢ã®å®Ÿè³ªå¹…ï¼ˆä½™ç™½ã¶ã‚“å¼•ãï¼‰
  const wrap = document.querySelector(".pyramidWrap");
  const w = wrap ? wrap.clientWidth : card.clientWidth;

  // ç«¯åˆ‡ã‚Œã—ãªã„ã‚ˆã†ã« 5å€‹ä¸¦ã¶è¡Œã®å¹…ã‹ã‚‰ slot ã‚’é€†ç®—
  const paddingX = 24; // ç›®å®‰ï¼ˆwrapã®å·¦å³ä½™ç™½ï¼‰
  const maxRow = 5;

  // gapã¯å°ã•ã™ãã‚‹ã¨è©°ã¾ã‚‹ã®ã§ clamp
  const gap = Math.max(10, Math.min(18, Math.floor(w * 0.035)));
  const available = Math.max(260, w - paddingX);
  const slot = Math.floor((available - gap * (maxRow - 1)) / maxRow);

  // iPhoneã§å…¨éƒ¨è¦‹ãˆã‚‹ã‚ˆã†ã«ä¸Šé™/ä¸‹é™ã‚’è¨­å®š
  const finalSlot = Math.max(62, Math.min(98, slot));
  const ring = Math.max(4, Math.round(finalSlot * 0.065));
  const rowgap = Math.max(14, Math.round(finalSlot * 0.20));
  const badge = Math.max(24, Math.round(finalSlot * 0.34));
  const badgeFont = Math.max(12, Math.round(badge * 0.45));

  document.documentElement.style.setProperty("--slot", finalSlot + "px");
  document.documentElement.style.setProperty("--ring", ring + "px");
  document.documentElement.style.setProperty("--gap", gap + "px");
  document.documentElement.style.setProperty("--rowgap", rowgap + "px");
  document.documentElement.style.setProperty("--badge", badge + "px");
  document.documentElement.style.setProperty("--badgeFont", badgeFont + "px");

  // ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ã‚‚ç«¯æœ«ã§å¾®èª¿æ•´ï¼ˆé‚ªé­”ã«ãªã‚‰ãªã„ï¼‰
  const headerH = Math.max(84, Math.min(110, Math.round(finalSlot * 1.05)));
  document.documentElement.style.setProperty("--headerH", headerH + "px");
}

/* =========================
   ãƒ”ãƒ©ãƒŸãƒƒãƒ‰æç”»
========================= */
function drawPyramid(){
  const p = document.getElementById("pyramid");
  p.innerHTML = "";

  let rank = 1;

  rowSizes.forEach((size)=>{
    const row = document.createElement("div");
    row.className = "row";

    for(let k=0; k<size; k++){
      const slot = document.createElement("div");
      slot.className = "slot";

      if(rank <= selected.length){
        const tIndex = selected[rank-1];
        const m = trainees[tIndex];

        slot.innerHTML = `
          <div class="avatar">
            <div class="avatarImg" style="background-image:url('${m.img}')"></div>
            <div class="rank">${rank}</div>
          </div>
          <div class="name">${escapeHtml(displayJPName(m.name))}</div>
          <div class="reorder">
            <button onclick="moveLeft(${rank-1})" aria-label="left">â†</button>
            <button onclick="moveRight(${rank-1})" aria-label="right">â†’</button>
          </div>
        `;
      } else {
        slot.classList.add("empty");
        slot.innerHTML = `
          <div class="avatar">
            <div class="plus">ï¼‹</div>
            <div class="rank">${rank}</div>
          </div>
          <div class="name"></div>
          <div class="reorder" style="visibility:hidden;">
            <button>â†</button><button>â†’</button>
          </div>
        `;
      }

      row.appendChild(slot);
      rank++;
    }

    p.appendChild(row);
  });
}

/* =========================
   ä¿å­˜ç”¨ï¼ˆ1004Ã—924ï¼‰ãƒ”ãƒ©ãƒŸãƒƒãƒ‰æç”»
========================= */
function drawExportPyramid(){
  const p = document.getElementById("exportPyramid");
  p.innerHTML = "";

  let rank = 1;

  rowSizes.forEach((size)=>{
    const row = document.createElement("div");
    row.className = "exportRow";

    for(let k=0;k<size;k++){
      const slot = document.createElement("div");
      slot.className = "exportSlot";

      if(rank <= selected.length){
        const m = trainees[selected[rank-1]];
        slot.innerHTML = `
          <div class="exportAvatar">
            <div class="exportAvatarImg" style="background-image:url('${m.img}')"></div>
            <div class="exportRank">${rank}</div>
          </div>
          <div class="exportName">${escapeHtml(displayJPName(m.name))}</div>
        `;
      } else {
        slot.classList.add("exportEmpty");
        slot.innerHTML = `
          <div class="exportAvatar">
            <div class="exportPlus">ï¼‹</div>
            <div class="exportRank">${rank}</div>
          </div>
          <div class="exportName"></div>
        `;
      }

      row.appendChild(slot);
      rank++;
    }
    p.appendChild(row);
  });
}

/* =========================
   ä¸€è¦§ï¼šæ¤œç´¢ + è¡¨ç¤ºåˆ‡æ›¿
========================= */
function setView(mode){
  viewMode = mode;
  saveViewMode();
  applyViewButtons();
  drawMembers();
}
function applyViewButtons(){
  document.getElementById("btnList").classList.toggle("active", viewMode === "list");
  document.getElementById("btnGrid").classList.toggle("active", viewMode === "grid");
  const members = document.getElementById("members");
  members.className = viewMode;
}

function getFilteredIndexes(){
  const q = normalize(query);
  if(!q) return trainees.map((_,i)=>i);

  const result = [];
  for(let i=0;i<trainees.length;i++){
    const full = trainees[i].name;
    const jp = displayJPName(full);
    const code = codeInParen(full);

    const key = normalize(full) + " " + normalize(jp) + " " + normalize(code);
    if(key.includes(q)) result.push(i);
  }
  return result;
}

function drawMembers(){
  const members = document.getElementById("members");
  const noResult = document.getElementById("noResult");
  members.innerHTML = "";

  const indexes = getFilteredIndexes();

  if(indexes.length === 0){
    noResult.style.display = "block";
    return;
  }
  noResult.style.display = "none";

  indexes.forEach((i)=>{
    const m = trainees[i];
    const chosen = selected.includes(i);

    const card = document.createElement("div");
    card.className = "member " + (viewMode === "grid" ? "gridCard" : "listRow");
    if(chosen) card.classList.add("selected");

    const jpName = displayJPName(m.name);
    const code = codeInParen(m.name);

    if(viewMode === "grid"){
      card.innerHTML = `
        <div class="thumb" style="background-image:url('${m.img}')"></div>
        <div class="memberName">${escapeHtml(jpName)}</div>
      `;
    }else{
      card.innerHTML = `
        <div class="thumbSmall" style="background-image:url('${m.img}')"></div>
        <div>
          <div class="memberNameRow">${escapeHtml(jpName)}</div>
          <div class="memberSub">${escapeHtml(code ? "(" + code + ")" : "")}</div>
        </div>
      `;
    }

    card.addEventListener("click", ()=>addMember(i));
    members.appendChild(card);
  });
}

/* =========================
   è¿½åŠ  / æˆ»ã™ / ãƒªã‚»ãƒƒãƒˆ / ä¸¦ã³æ›¿ãˆ
========================= */
function addMember(i){
  if(selected.length >= MAX){
    alert("11äººã¾ã§ï¼");
    return;
  }
  if(selected.includes(i)) return;

  selected.push(i);
  saveSelected();

  drawPyramid();
  drawExportPyramid();
  drawMembers();
}

function undo(){
  selected.pop();
  saveSelected();
  drawPyramid();
  drawExportPyramid();
  drawMembers();
}

function resetAll(){
  selected = [];
  saveSelected();
  drawPyramid();
  drawExportPyramid();
  drawMembers();
}

function moveLeft(pos){
  if(pos <= 0) return;
  const tmp = selected[pos-1];
  selected[pos-1] = selected[pos];
  selected[pos] = tmp;
  saveSelected();
  drawPyramid();
  drawExportPyramid();
  drawMembers();
}
function moveRight(pos){
  if(pos >= selected.length-1) return;
  const tmp = selected[pos+1];
  selected[pos+1] = selected[pos];
  selected[pos] = tmp;
  saveSelected();
  drawPyramid();
  drawExportPyramid();
  drawMembers();
}

/* =========================
   ä¿å­˜ï¼ˆ1004Ã—924 å›ºå®šï¼‰
========================= */
async function saveImage(){
  if(typeof html2canvas === "undefined"){
    alert("ç”»åƒä¿å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    return;
  }

  // æœ€æ–°çŠ¶æ…‹ã«ã—ã¦ã‹ã‚‰ä¿å­˜
  drawExportPyramid();

  const toast = document.getElementById("toast");
  toast.style.display = "block";

  try{
    const target = document.getElementById("exportInner");
    const canvas = await html2canvas(target, {
      backgroundColor: "#ffffff",
      useCORS: true,
      allowTaint: false,
      scale: 2
    });

    const link = document.createElement("a");
    link.download = "oshimaker_1004x924.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  }catch(e){
    alert("ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç”»åƒURLå´ã®åˆ¶é™ã®å¯èƒ½æ€§ï¼‰ã€‚");
  }finally{
    toast.style.display = "none";
  }
}

/* =========================
   æ°¸ç¶šåŒ–
========================= */
function saveSelected(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(selected)); }catch(e){}
}
function loadSelected(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr.filter(n=>Number.isInteger(n)).slice(0, MAX) : [];
  }catch(e){
    return [];
  }
}
function saveViewMode(){
  try{ localStorage.setItem("oshimaker_viewMode", viewMode); }catch(e){}
}
function loadViewMode(){
  try{
    const v = localStorage.getItem("oshimaker_viewMode");
    return (v === "list" || v === "grid") ? v : "grid";
  }catch(e){
    return "grid";
  }
}

/* =========================
   æ¤œç´¢å…¥åŠ›
========================= */
const searchEl = document.getElementById("search");
const clearEl = document.getElementById("clear");

searchEl.addEventListener("input", ()=>{
  query = searchEl.value || "";
  drawMembers();
});
clearEl.addEventListener("click", ()=>{
  searchEl.value = "";
  query = "";
  drawMembers();
  searchEl.focus();
});

/* =========================
   å³ã‚¯ãƒªãƒƒã‚¯/ãƒ‰ãƒ©ãƒƒã‚°ä¿å­˜ãªã©ã‚’æŠ‘åˆ¶ï¼ˆå®Œå…¨é˜²æ­¢ã¯ä¸å¯ï¼‰
========================= */
document.addEventListener("contextmenu", (e)=> e.preventDefault(), {passive:false});
document.addEventListener("dragstart", (e)=> e.preventDefault(), {passive:false});

/* =========================
   XSSå¯¾ç­–ï¼ˆåå‰è¡¨ç¤ºç”¨ï¼‰
========================= */
function escapeHtml(str){
  return (str||"").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

/* =========================
   åˆæœŸæç”»
========================= */
function boot(){
  updatePyramidSizes();
  applyViewButtons();
  drawPyramid();
  drawExportPyramid();
  drawMembers();
}

window.addEventListener("resize", ()=>{
  updatePyramidSizes();
  drawPyramid(); // ã‚µã‚¤ã‚ºå¤‰æ›´ã§ã‚ºãƒ¬é˜²æ­¢
});

boot();
</script>

</body>
</html>
