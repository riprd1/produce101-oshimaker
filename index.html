<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>日プ新世界 推しメーカー</title>

  <style>
    :root{
      --bg:#f6f6f6;
      --card:#ffffff;
      --line:#e6e6e6;
      --text:#111;
      --muted:#666;
      --shadow: 0 4px 14px rgba(0,0,0,.06);
      --radius:14px;
      --blue:#1a73e8;

      /* 画面表示の丸サイズ（iPhoneでも11枠が見えるように可変） */
      --circle: clamp(58px, 12.8vw, 90px);
      --ring: clamp(5px, 1.2vw, 8px);

      /* ピラミッド間隔（可変） */
      --row-gap: clamp(14px, 3.2vw, 26px);
      --col-gap-12: clamp(14px, 4.2vw, 28px);
      --col-gap-3: clamp(12px, 3.6vw, 24px);
      --col-gap-5: clamp(10px, 2.4vw, 18px);

      --name-size: clamp(11px, 2.8vw, 14px);
      --badge-size: clamp(13px, 3.2vw, 16px);
      --badge-pad-x: clamp(10px, 2.8vw, 14px);
      --badge-pad-y: clamp(7px, 1.9vw, 9px);
    }

    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-touch-callout: none; /* iOS長押し保存の抑制 */
      -webkit-user-select: none;
      user-select: none;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .topbar{
      padding: 12px 12px 10px;
      max-width: 980px;
      margin: 0 auto;
    }
    h1{margin:0;font-size:20px;line-height:1.2}
    .by{margin:6px 0 0;font-size:13px;color:var(--muted)}
    main{max-width:980px;margin:0 auto;padding:12px;}

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    /* ===== メインのヘッダー画像帯 ===== */
    .banner{
      height: 96px;
      position: relative;
      background-size: cover;
      background-position: center;
    }
    .banner::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(to bottom, rgba(255,255,255,.0), rgba(255,255,255,.35));
      pointer-events:none;
    }
    .bannerTitle{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%); /* ★上下中央固定 */
      font-weight: 900;
      letter-spacing: .06em;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(255,255,255,.90);
      font-size: 14px;
      color:#111;
      white-space: nowrap;
    }

    /* ===== ピラミッド ===== */
    .pyramidPad{padding: 10px 10px 10px;}
    .pyramid{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: var(--row-gap);
      padding: 10px 0 6px;
    }
    .row{
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    .row.r1{gap:0;}
    .row.r2{gap: var(--col-gap-12);}
    .row.r3{gap: var(--col-gap-3);}
    .row.r5{gap: var(--col-gap-5);}

    .slot{
      width: calc(var(--circle) + 24px);
      text-align:center;
      position:relative;
      touch-action: manipulation;
    }

    .avatar{
      width: var(--circle);
      height: var(--circle);
      border-radius: 999px;
      border: var(--ring) solid #d7d7d7;
      background:#fff;
      overflow:hidden;
      margin:0 auto;
      box-shadow: 0 8px 18px rgba(0,0,0,.10);
      position:relative;
    }
    .avatar img{
      width:100%;
      height:100%;
      object-fit: cover; /* ★顔つぶれゼロ */
      display:block;
      pointer-events:none;
      -webkit-user-drag: none;
      user-drag: none;
    }

    /* ★順位バッジ：丸の真ん中下に完全センター固定（ズレ対策） */
    .rank{
      position:absolute;
      left:50%;
      bottom: calc(-1 * (var(--badge-size) * 0.9));
      transform: translateX(-50%);
      background: var(--blue);
      color:#fff;
      border-radius: 999px;
      font-size: var(--badge-size);
      font-weight: 900;
      padding: var(--badge-pad-y) var(--badge-pad-x);
      border: 3px solid #fff;
      line-height: 1;
      z-index: 9999; /* ★絶対に隠れない */
      box-shadow: 0 4px 10px rgba(0,0,0,.14);
      min-width: 2.4em;
      text-align:center;
      box-sizing:border-box;
    }

    /* ★名前：順位の下（重なり防止） */
    .name{
      margin-top: calc(var(--badge-size) * 1.3);
      font-size: var(--name-size);
      font-weight: 800;
      line-height: 1.15;
      padding: 0 2px;
      word-break: keep-all;
      overflow-wrap: anywhere;
      display: -webkit-box;
      -webkit-line-clamp: 2;          /* 長い名前は2行まで */
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: calc(var(--name-size) * 2.4); /* 高さを揃えて崩れにくく */
    }

    /* 空き（＋） */
    .empty .avatar{
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: calc(var(--circle) * 0.42);
      font-weight: 900;
      color:#777;
      opacity:.28;
    }
    .empty .name{
      opacity:.0;
    }
    .empty .rank{
      opacity:.65;
    }

    /* ===== 操作ボタン ===== */
    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      padding: 10px 10px 12px;
    }
    button{
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: #fff;
      font-size: 14px;
      touch-action: manipulation;
    }
    button:active{transform:scale(.98)}
    .primary{border-color: #cfe2ff;}
    .danger{border-color:#ffd6d6;}

    /* ===== 並び替え（普段は非表示、モードON時だけ表示） ===== */
    .reorderRow{
      display:none;
      justify-content:center;
      gap:10px;
      margin-top: 8px;
    }
    .reorderRow button{
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 16px;
      line-height: 1;
    }
    body.reorder-on .reorderRow{display:flex;}

    /* ===== 練習生一覧（縦1列固定） ===== */
    .listCard{
      margin-top: 12px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .listHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border-bottom: 1px solid var(--line);
      position: sticky;
      top: 58px; /* headerの下に追従 */
      background: rgba(255,255,255,.96);
      backdrop-filter: blur(10px);
      z-index: 5;
    }

    .searchWrap{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .search{
      flex:1;
      display:flex;
      align-items:center;
      border: 1px solid #e3e3e3;
      border-radius: 14px;
      padding: 10px 12px;
      background:#fff;
      box-shadow: 0 3px 12px rgba(0,0,0,.05);
    }
    .search input{
      width:100%;
      border:0;
      outline:0;
      font-size:14px;
      background:transparent;
      user-select: text;
      -webkit-user-select: text;
    }
    .search input::placeholder{color:#aaa;}
    .clearBtn{
      border: 1px solid #e3e3e3;
      border-radius: 12px;
      padding: 9px 10px;
      background:#fff;
      font-size: 13px;
    }

    .listBody{
      max-height: 48vh;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .memberRow{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 10px 12px;
      border-bottom: 1px solid #f0f0f0;
      cursor:pointer;
    }
    .memberRow:active{transform: scale(.99);}
    .memberRow img{
      width:48px;height:48px;border-radius:999px;
      object-fit:cover;
      border: 2px solid #eee;
      flex:0 0 auto;
      pointer-events:none;
      -webkit-user-drag: none;
      user-drag: none;
    }
    .memberText{
      flex:1;
      min-width:0;
    }
    .memberName{
      font-weight:900;
      font-size:14px;
      line-height:1.2;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .memberSub{
      font-size:12px;
      color:var(--muted);
      margin-top: 3px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .memberRow.selected{
      opacity:.38;
      filter: grayscale(1);
      pointer-events:none;
    }

    /* ===== 画像保存のときだけ出すトースト ===== */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.78);
      color:#fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      display:none;
      z-index:9999;
    }

    /* ===== 保存専用（画面外） =====
       参考画像の「正方形 1080×1080」に合わせる */
    #exportArea{
      position: fixed;
      left: -10000px;
      top: 0;
      width: 1080px;
      height: 1080px; /* ★参考画像と同じ正方形 */
      background:#fff;
      overflow:hidden;
    }
    #exportInner{
      width:1080px;
      height:1080px;
      background:#fff;
      position:relative;
    }
    .exportBanner{
      height: 150px;
      background-size: cover;
      background-position: center;
      position:relative;
    }
    .exportBanner::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(to bottom, rgba(255,255,255,.0), rgba(255,255,255,.30));
      pointer-events:none;
    }
    .exportPill{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%); /* ★上下中央固定 */
      font-weight: 900;
      letter-spacing: .06em;
      padding: 14px 22px;
      border-radius: 999px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(255,255,255,.90);
      font-size: 22px;
      white-space: nowrap;
    }
    .exportBody{
      padding: 18px 60px 0;
    }
    .exportPyramid{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 30px;
      padding-top: 8px;
    }
    .exportRow{
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    .exportRow.r1{gap:0;}
    .exportRow.r2{gap: 64px;}
    .exportRow.r3{gap: 52px;}
    .exportRow.r5{gap: 26px;} /* ★端が切れないように狭める */

    .exportSlot{
      width: 160px;
      text-align:center;
      position:relative;
    }
    .exportAvatar{
      width: 124px;
      height: 124px;
      border-radius:999px;
      border: 8px solid #d7d7d7;
      overflow:hidden;
      margin:0 auto;
      background:#fff;
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
      position:relative;
    }
    .exportAvatar img{
      width:100%;height:100%;
      object-fit:cover;
      display:block;
      pointer-events:none;
      -webkit-user-drag:none;
      user-drag:none;
    }
    .exportRank{
      position:absolute;
      left:50%;
      bottom:-14px;
      transform: translateX(-50%);
      background: var(--blue);
      color:#fff;
      border-radius:999px;
      font-weight: 900;
      font-size: 16px;
      padding: 8px 14px;
      border: 4px solid #fff;
      line-height:1;
      z-index: 9999;
      min-width: 2.4em;
      text-align:center;
      box-sizing:border-box;
      box-shadow: 0 6px 14px rgba(0,0,0,.14);
    }
    .exportName{
      margin-top: 24px; /* ★順位の下に必ず来る */
      font-size: 16px;
      font-weight: 900;
      line-height: 1.15;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height: 2.3em; /* 崩れ防止 */
      padding: 0 6px;
      overflow-wrap:anywhere;
    }
    .exportEmpty .exportAvatar{
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 44px;
      font-weight: 900;
      color:#777;
      opacity:.28;
    }
    .exportFooterLeft{
      position:absolute;
      left: 26px;
      bottom: 18px;
      font-size: 18px;
      color:#888;
      font-weight:700;
    }
    .exportFooterRight{
      position:absolute;
      right: 26px;
      bottom: 18px;
      font-size: 18px;
      color:#000;
      font-weight:900;
    }

    /* 右クリック/長押しメニュー抑制（完全防止は不可だが軽減） */
    img{ -webkit-touch-callout:none; }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <h1>日プ新世界 推しメーカー</h1>
      <p class="by">created by @12agassi</p>
    </div>
  </header>

  <main>
    <div class="card">
      <div id="banner" class="banner">
        <div class="bannerTitle">AUDITION PICK • YOUR TOP 11</div>
      </div>

      <div class="pyramidPad">
        <div class="pyramid" id="pyramid"></div>
      </div>

      <div class="actions">
        <button class="primary" onclick="saveImage()">画像として保存</button>
        <button onclick="undo()">1人戻す</button>
        <button onclick="resetAll()" class="danger">リセット</button>
        <button id="reorderBtn" onclick="toggleReorder()">並び替えモード：OFF</button>
      </div>
    </div>

    <div class="listCard">
      <div class="listHeader">
        <div class="searchWrap">
          <div class="search">
            <input id="search" type="text" placeholder="Search" />
          </div>
          <button class="clearBtn" onclick="clearSearch()">クリア</button>
        </div>
      </div>

      <div class="listBody" id="membersList"></div>
    </div>
  </main>

  <div class="toast" id="toast">画像を生成中…</div>

  <!-- 保存専用 -->
  <div id="exportArea" aria-hidden="true">
    <div id="exportInner">
      <div id="exportBanner" class="exportBanner">
        <div class="exportPill">AUDITION PICK • YOUR TOP 11</div>
      </div>

      <div class="exportBody">
        <div class="exportPyramid" id="exportPyramid"></div>
      </div>

      <div class="exportFooterLeft">created by @12agassi</div>
      <div class="exportFooterRight" id="exportTime">at ----/--/-- --:--</div>
    </div>
  </div>

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    /* ===== ヘッダー画像 ===== */
    const HEADER_IMAGE_URL = "https://i.imgur.com/nYBRUdd.png";

    /* ===== 練習生データ =====
       表示は「()内の英字を除いた日本語名」
       検索は「日本語名」も「英字」も両方ヒット
    */
    const trainees = [
      { name:"アダム・ナガイ(ADAM)", img:"https://i.imgur.com/6QGzvRx.png" },
      { name:"中丸 晏寿(AJU)", img:"https://i.imgur.com/KiZCKos.png" },
      { name:"オム・スアンカワーテン(AOM)", img:"https://i.imgur.com/dDIFJSc.png" },
      { name:"アーチャー・ウイ(ARCHER)", img:"https://i.imgur.com/5iIerqN.png" },
      { name:"篠ヶ谷 歩夢(S.AYUMU)", img:"https://i.imgur.com/YJAdh8q.png" },

      { name:"小林 千悟(CHISATO)", img:"https://i.imgur.com/Iu0hNBO.png" },
      { name:"加藤 大樹(K.DAIKI)", img:"https://i.imgur.com/4fRk2EB.png" },
      { name:"カク・ドンミン(DONGMIN)", img:"https://i.imgur.com/xZSQqMh.png" },
      { name:"末川 瑛太(EITA)", img:"https://i.imgur.com/alEjKCP.png" },
      { name:"保里 瑛都(H.EITO)", img:"https://i.imgur.com/IAhs4ZA.png" },
      { name:"金田 栄都(K.EITO)", img:"https://i.imgur.com/tF7i1du.png" },
      { name:"櫻井 楓真(FUMA)", img:"https://i.imgur.com/WIWI8Sx.png" },
    ];

    const rowSizes = [1,2,3,5];
    const STORAGE_KEY = "oshimaker_selected_final_v1";
    const MAX = 11;

    // 選択は「traineesのindex」配列
    let selected = loadSelected();

    // 並び替えモード
    let reorderOn = false;

    // 右クリック/長押しメニュー抑制
    document.addEventListener("contextmenu", (e)=> e.preventDefault(), {passive:false});

    // ヘッダー帯に画像
    (function setupBanners(){
      const banner = document.getElementById("banner");
      const exportBanner = document.getElementById("exportBanner");
      if(HEADER_IMAGE_URL){
        banner.style.backgroundImage = `url('${HEADER_IMAGE_URL}')`;
        exportBanner.style.backgroundImage = `url('${HEADER_IMAGE_URL}')`;
      }
    })();

    // 表示名（()内を除いた名前）
    function displayName(full){
      // 末尾の (XXXX) を削除
      return String(full).replace(/\s*\([^)]*\)\s*$/,"").trim();
    }
    // 検索用（日本語+英字どっちも）
    function alphaName(full){
      const m = String(full).match(/\(([^)]+)\)\s*$/);
      return m ? m[1] : "";
    }

    function saveSelected(){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(selected)); }catch(e){}
    }
    function loadSelected(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        const cleaned = Array.isArray(arr) ? arr.filter(n=>Number.isInteger(n)) : [];
        return cleaned.filter(n => n>=0 && n<trainees.length).slice(0, MAX);
      }catch(e){
        return [];
      }
    }

    /* ===== ピラミッド描画（＋あり、常に11枠） ===== */
    function drawPyramid(){
      const p = document.getElementById("pyramid");
      p.innerHTML = "";

      const rows = [
        {cls:"r1", size:1},
        {cls:"r2", size:2},
        {cls:"r3", size:3},
        {cls:"r5", size:5},
      ];

      let idx = 0;
      rows.forEach(r=>{
        const row = document.createElement("div");
        row.className = `row ${r.cls}`;

        for(let k=0;k<r.size;k++){
          const slot = document.createElement("div");
          slot.className = "slot";

          const rankNum = idx+1;

          if(idx < selected.length){
            const t = trainees[selected[idx]];
            slot.innerHTML = `
              <div class="avatar">
                <img src="${t.img}" alt="" draggable="false">
              </div>
              <div class="rank">${rankNum}</div>
              <div class="name">${escapeHtml(displayName(t.name))}</div>
              <div class="reorderRow">
                <button onclick="moveLeft(${idx})" aria-label="left">←</button>
                <button onclick="moveRight(${idx})" aria-label="right">→</button>
              </div>
            `;
          }else{
            slot.classList.add("empty");
            slot.innerHTML = `
              <div class="avatar">+</div>
              <div class="rank">${rankNum}</div>
              <div class="name">　</div>
              <div class="reorderRow"></div>
            `;
          }

          row.appendChild(slot);
          idx++;
        }

        p.appendChild(row);
      });
    }

    /* ===== 保存用ピラミッド（1080×1080に最適化、切れない） ===== */
    function drawExportPyramid(){
      const p = document.getElementById("exportPyramid");
      p.innerHTML = "";

      const rows = [
        {cls:"r1", size:1},
        {cls:"r2", size:2},
        {cls:"r3", size:3},
        {cls:"r5", size:5},
      ];

      let idx = 0;
      rows.forEach(r=>{
        const row = document.createElement("div");
        row.className = `exportRow ${r.cls}`;

        for(let k=0;k<r.size;k++){
          const slot = document.createElement("div");
          slot.className = "exportSlot";

          const rankNum = idx+1;

          if(idx < selected.length){
            const t = trainees[selected[idx]];
            slot.innerHTML = `
              <div class="exportAvatar">
                <img src="${t.img}" alt="" draggable="false" crossorigin="anonymous">
              </div>
              <div class="exportRank">${rankNum}</div>
              <div class="exportName">${escapeHtml(displayName(t.name))}</div>
            `;
          }else{
            slot.classList.add("exportEmpty");
            slot.innerHTML = `
              <div class="exportAvatar">+</div>
              <div class="exportRank">${rankNum}</div>
              <div class="exportName">　</div>
            `;
          }

          row.appendChild(slot);
          idx++;
        }

        p.appendChild(row);
      });
    }

    /* ===== 一覧（縦1列 + Search） ===== */
    function drawMembersList(){
      const list = document.getElementById("membersList");
      list.innerHTML = "";

      const q = (document.getElementById("search").value || "").trim().toLowerCase();

      trainees.forEach((t,i)=>{
        const disp = displayName(t.name);
        const alpha = alphaName(t.name);
        const hay = (t.name + " " + disp + " " + alpha).toLowerCase();

        if(q && !hay.includes(q)) return;

        const row = document.createElement("div");
        row.className = "memberRow";
        if(selected.includes(i)) row.classList.add("selected");

        row.innerHTML = `
          <img src="${t.img}" alt="" draggable="false">
          <div class="memberText">
            <div class="memberName">${escapeHtml(disp)}</div>
            <div class="memberSub">${escapeHtml(alpha ? "(" + alpha + ")" : "")}</div>
          </div>
        `;
        row.addEventListener("click", ()=>add(i));
        list.appendChild(row);
      });
    }

    /* ===== 追加 ===== */
    function add(i){
      if(selected.length >= MAX){
        alert("11人まで！");
        return;
      }
      if(selected.includes(i)) return;
      selected.push(i);
      saveSelected();
      redrawAll();
      // 追加後、上のピラミッドが見えるように少し上へ
      window.scrollTo({top: 0, behavior:"smooth"});
    }

    /* ===== 1人戻す ===== */
    function undo(){
      selected.pop();
      saveSelected();
      redrawAll();
    }

    /* ===== リセット ===== */
    function resetAll(){
      selected = [];
      saveSelected();
      redrawAll();
    }

    /* ===== 並び替え ===== */
    function toggleReorder(){
      reorderOn = !reorderOn;
      document.body.classList.toggle("reorder-on", reorderOn);
      document.getElementById("reorderBtn").textContent = `並び替えモード：${reorderOn ? "ON" : "OFF"}`;
    }

    // 並び替えは「選択済みの範囲内」だけ
    function moveLeft(pos){
      if(!reorderOn) return;
      if(pos<=0) return;
      const tmp = selected[pos-1];
      selected[pos-1] = selected[pos];
      selected[pos] = tmp;
      saveSelected();
      redrawAll(false);
    }
    function moveRight(pos){
      if(!reorderOn) return;
      if(pos>=selected.length-1) return;
      const tmp = selected[pos+1];
      selected[pos+1] = selected[pos];
      selected[pos] = tmp;
      saveSelected();
      redrawAll(false);
    }

    /* ===== 保存（正方形1080×1080） ===== */
    async function saveImage(){
      if(typeof html2canvas === "undefined"){
        alert("画像保存ライブラリの読み込みに失敗しました。");
        return;
      }

      // 最新化
      drawExportPyramid();
      setExportTime();

      const toast = document.getElementById("toast");
      toast.style.display = "block";

      try{
        const target = document.getElementById("exportInner");
        const canvas = await html2canvas(target, {
          backgroundColor:"#ffffff",
          useCORS:true,
          allowTaint:false,
          scale: 2
        });

        const link = document.createElement("a");
        link.download = "oshimaker.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      }catch(e){
        alert("画像生成に失敗しました。画像URL側の制限の可能性があります（imgurは基本OK）。");
      }finally{
        toast.style.display = "none";
      }
    }

    function setExportTime(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      document.getElementById("exportTime").textContent = `at ${yyyy}/${mm}/${dd} ${hh}:${mi}`;
    }

    /* ===== Search ===== */
    document.getElementById("search").addEventListener("input", ()=>{
      drawMembersList();
    });

    function clearSearch(){
      document.getElementById("search").value = "";
      drawMembersList();
    }

    /* ===== ユーティリティ ===== */
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function redrawAll(redrawList=true){
      drawPyramid();
      drawExportPyramid();
      if(redrawList) drawMembersList();
      // 並び替えON/OFF状態維持
      document.body.classList.toggle("reorder-on", reorderOn);
      document.getElementById("reorderBtn").textContent = `並び替えモード：${reorderOn ? "ON" : "OFF"}`;
    }

    /* 初期描画 */
    redrawAll();
    setExportTime();
  </script>
</body>
</html>
